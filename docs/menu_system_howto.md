# HowTo: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é (/start)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å, –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø—É–Ω–∫—Ç—ã –≥–ª–∞–≤–Ω–æ–≥–æ inline-–º–µ–Ω—é.

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫—Ä–∞—Ç–∫–æ
- –ö–æ–¥ –º–µ–Ω—é: `bot/menu_system.py`
- –†–µ–µ—Å—Ç—Ä –ø—É–Ω–∫—Ç–æ–≤: `MENU_REGISTRY` (—Å–ø–∏—Å–æ–∫ `MenuEntry`)
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: —á–µ—Ä–µ–∑ `register_menu({...})` –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–ª–∞–≥–∏–Ω–∞).
- Callback: inline-–∫–Ω–æ–ø–∫–∏ –∏–º–µ—é—Ç `data="menu:<key>"`; –æ–±—â–∏–π —Ä–æ—É—Ç–µ—Ä –ª–æ–≤–∏—Ç `'^menu:'` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `dispatch_command`.
- –ö—ç—à –∫–Ω–æ–ø–æ–∫ –ø–æ —è–∑—ã–∫—É: `MENU_CACHE`.

## 2. –§–æ—Ä–º–∞—Ç –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é
–ü—Ä–∏–º–µ—Ä –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
```python
register_menu({
  'key': 'today',          # —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–ª—é—á
  'tr_key': 'menu_today',  # –∫–ª—é—á –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
  'plugin': 'today',       # –∏–º—è –ø–∞–ø–∫–∏ –ø–ª–∞–≥–∏–Ω–∞ (–∫–ª—é—á –≤ tlgbot._plugins)
  'handler': 'today_handler',  # –∏–º—è async —Ñ—É–Ω–∫—Ü–∏–∏
  'order': 10              # –ø–æ—Ä—è–¥–æ–∫ (–º–µ–Ω—å—à–µ -> —Ä–∞–Ω—å—à–µ)
})
```

## 3. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é
1. –°–æ–∑–¥–∞–π (–∏–ª–∏ –æ—Ç–∫—Ä–æ–π) —Ñ–∞–π–ª –ø–ª–∞–≥–∏–Ω–∞: `bot/plugins_bot/<newcmd>/<newcmd>.py`.
2. –í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤ –¥–æ–±–∞–≤—å:
```python
try:
    from bot.menu_system import register_menu
    register_menu({
        'key': 'newcmd',
        'tr_key': 'menu_newcmd',
        'plugin': 'newcmd',
        'handler': 'newcmd_handler',
        'order': 50
    })
except Exception:
    pass
```
3. –†–µ–∞–ª–∏–∑—É–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã:
```python
@tlgbot.on(tlgbot.cmd('newcmd'))
async def newcmd_handler(event):
    await event.respond("–ö–æ–º–∞–Ω–¥–∞ newcmd —Ä–∞–±–æ—Ç–∞–µ—Ç!")
```
4. –î–æ–±–∞–≤—å –ø–µ—Ä–µ–≤–æ–¥ –≤ –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –ª–æ–∫–∞–ª–∏ `bot/locales/*.json`:
```json
"menu_newcmd": "üÜï –ù–æ–≤–æ–µ"
```
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞. –ü—Ä–∏ `/start` –ø—É–Ω–∫—Ç –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## 4. –£–¥–∞–ª–∏—Ç—å –ø—É–Ω–∫—Ç –º–µ–Ω—é
1. –ù–∞–π–¥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é `register_menu({... 'key': 'X' ...})` –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º –ø–ª–∞–≥–∏–Ω–µ.
2. –£–¥–∞–ª–∏ –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —ç—Ç–æ—Ç –±–ª–æ–∫.
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞. (–ü—Ä–∏ hot-reload —Å—Ç–∞—Ä—ã–π –ø—É–Ω–∫—Ç –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –≤ –∫—ç—à–µ ‚Äî –æ—á–∏—Å—Ç–∫–∞: —Å–º. —Ä–∞–∑–¥–µ–ª 8.)

## 5. –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
1. –ü—Ä–∞–≤—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (`tr_key`) –≤ JSON —Ñ–∞–π–ª–∞—Ö –ª–æ–∫–∞–ª–µ–π.
2. –ù–µ –º–µ–Ω—è–π `key`, –∏–Ω–∞—á–µ —Å–ª–æ–º–∞–µ—Ç—Å—è callback —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
3. –û—á–∏—Å—Ç–∏ –∫—ç—à –º–µ–Ω—é (—Å–º. —Ä–∞–∑–¥–µ–ª 8) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ `/start` –∑–∞–Ω–æ–≤–æ ‚Äî –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞/—Ä–µ—Å—Ç–∞—Ä—Ç–µ –∫—ç—à –æ–±–Ω–æ–≤–∏—Ç—Å—è.

## 6. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å handler –∏–ª–∏ plugin
- –ï—Å–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª —Ñ–∞–π–ª –ø–ª–∞–≥–∏–Ω–∞ (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é) ‚Äî –æ–±–Ω–æ–≤–∏ –ø–æ–ª–µ `plugin` –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
- –ï—Å–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏—é ‚Äî –æ–±–Ω–æ–≤–∏ `handler`.
- –ò–Ω–∞—á–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –±—É–¥–µ—Ç –ª–æ–≥ `handler missing`.

## 7. –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫
- –ü—Ä–æ—Å—Ç–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π `order`. –ú–µ–Ω—å—à–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–¥—É—Ç –ø–µ—Ä–≤—ã–º–∏.
- –ö–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ 2 –≤ —Å—Ç—Ä–æ–∫–µ (–ª–æ–≥–∏–∫–∞ –≤ `build_menu`). –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏—Ç—å ‚Äî –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π `build_menu`.

## 8. –û—á–∏—Å—Ç–∫–∞ / –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –º–µ–Ω—é
–í –∫–æ–¥–µ:
```python
from bot.menu_system import invalidate_menu
invalidate_menu()        # –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à
invalidate_menu('ru')    # –æ—á–∏—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —è–∑—ã–∫–∞
```
–î–æ–±–∞–≤—å –≤—ã–∑–æ–≤ –ø–æ—Å–ª–µ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è –ø—É–Ω–∫—Ç–æ–≤.

## 9. Debug / –ø—Ä–æ–≤–µ—Ä–∫–∏
- –õ–æ–≥–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: `menu_system: registered menu entry <key>`
- –õ–æ–≥ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏: `menu_system: callback router attached` (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
- –û—à–∏–±–∫–∞ –ø–ª–∞–≥–∏–Ω–∞: `plugin X not loaded` ‚Äî –ø–ª–∞–≥–∏–Ω –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è/–æ—à–∏–±–∫–∞ –≤ –Ω—ë–º.
- –û—à–∏–±–∫–∞ —Ö–µ–Ω–¥–ª–µ—Ä–∞: `handler Y missing` ‚Äî –æ–ø–µ—á–∞—Ç–∫–∞ –≤ –∏–º–µ–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏.

## 10. –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏
| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|---------|
| –ö–Ω–æ–ø–∫–∞ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç | –ù–µ—Ç callback —Ä–æ—É—Ç–µ—Ä–∞ | –£–±–µ–¥–∏—Å—å —á—Ç–æ –≤—ã–∑–≤–∞–Ω `init_menu_system` (–¥–µ–ª–∞–µ—Ç—Å—è –≤ `/start`) |
| –ü–æ—è–≤–∏–ª—Å—è —Å—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç | –ö—ç—à –Ω–µ –æ—á–∏—â–µ–Ω | `invalidate_menu()` –∏–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç |
| –ü–∞–¥–∞–µ—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ | –ù–µ–≤–µ—Ä–Ω—ã–π handler/plugin | –ò—Å–ø—Ä–∞–≤—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é |
| –ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á –≤ –ª–æ–∫–∞–ª–∏ | –î–æ–±–∞–≤—å –∫–ª—é—á –≤–æ –≤—Å–µ JSON |

## 11. –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
- [ ] –ö–æ–¥ –ø–ª–∞–≥–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω
- [ ] register_menu –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] handler —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [ ] –ü–æ—Ä—è–¥–æ–∫ (order) –≤—ã—Å—Ç–∞–≤–ª–µ–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ `/start`

## 12. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É —Å—Ç—Ä–æ–∫–∏ (2) –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É.
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –ø—É–Ω–∫—Ç—ã (—Ñ–ª–∞–≥ `enabled` –≤ MenuEntry). *(—Å–ø–µ–∫—É–ª—è—Ü–∏—è)*
- –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª–µ–π (watcher). *(—Å–ø–µ–∫—É–ª—è—Ü–∏—è)*

## 13. FAQ
Q: –ù—É–∂–Ω–æ –ª–∏ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫–∏ –≤ start_cmd?  
A: –ù–µ—Ç, –æ–Ω–∏ —Å—Ç—Ä–æ—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞.

Q: –ú–æ–∂–Ω–æ –ª–∏ –∫–Ω–æ–ø–∫–µ –≤—ã–∑—ã–≤–∞—Ç—å –Ω–µ –∫–æ–º–∞–Ω–¥—É, –∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é?  
A: –î–∞, –≥–ª–∞–≤–Ω–æ–µ —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏—è –±—ã–ª–∞ async –∏ –∏–º—è —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å `handler`.

Q: –ß—Ç–æ –µ—Å–ª–∏ –¥–≤–∞ –ø–ª–∞–≥–∏–Ω–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π `key`?  
A: –í—Ç–æ—Ä–æ–π silently –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è ‚Äî —Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏.

---
–ö–æ—Ä–æ—Ç–∫–æ: –¥–æ–±–∞–≤–ª—è–µ—à—å register_menu + handler + –ø–µ—Ä–µ–≤–æ–¥ ‚Äî –≥–æ—Ç–æ–≤–æ.

## 14. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é
–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å pytest):
```python
from bot.menu_system import MENU_REGISTRY, register_menu, build_menu, invalidate_menu

def test_register_unique():
    invalidate_menu()
    before = len(MENU_REGISTRY)
    register_menu({'key':'_t1','tr_key':'menu_today','plugin':'today','handler':'today_handler','order':999})
    assert len(MENU_REGISTRY) == before + 1

def test_duplicate_ignored():
    before = len(MENU_REGISTRY)
    register_menu({'key':'_t1','tr_key':'menu_today','plugin':'today','handler':'today_handler','order':999})
    assert len(MENU_REGISTRY) == before  # –Ω–µ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å
```
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫: `buttons = build_menu('ru')` ‚Üí assert —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Å–ø–∏—Å–æ–∫ —Å–ø–∏—Å–∫–æ–≤), –Ω–∞–ª–∏—á–∏–µ callback data `menu:`.

## 15. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å *(–µ—Å–ª–∏ –≤–Ω–µ–¥—Ä—ë–Ω —Ñ–ª–∞–≥ enabled)*
- –†–∞—Å—à–∏—Ä—è–µ–º `MenuEntry` –ø–æ–ª–µ–º `enabled: bool = True`.
- –í `build_menu` –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –≥–¥–µ `enabled is False`.
- –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏:
```python
def disable_menu(key: str):
    for e in MENU_REGISTRY:
        if e.key == key:
            e.enabled = False
    MENU_CACHE.clear()

def enable_menu(key: str):
    for e in MENU_REGISTRY:
        if e.key == key:
            e.enabled = True
    MENU_CACHE.clear()
```
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç—å —ç–∫—Å–ø–æ—Ä—Ç ‚Üí `disable_menu('export')`.
