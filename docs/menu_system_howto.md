# HowTo: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é (/start)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å, –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø—É–Ω–∫—Ç—ã –≥–ª–∞–≤–Ω–æ–≥–æ inline-–º–µ–Ω—é.

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫—Ä–∞—Ç–∫–æ
- –ö–æ–¥ –º–µ–Ω—é: `bot/menu_system.py`
- –†–µ–µ—Å—Ç—Ä –ø—É–Ω–∫—Ç–æ–≤: `MENU_REGISTRY` (—Å–ø–∏—Å–æ–∫ `MenuEntry`)
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: —á–µ—Ä–µ–∑ `register_menu({...})` –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–ª–∞–≥–∏–Ω–∞).
- Callback: inline-–∫–Ω–æ–ø–∫–∏ –∏–º–µ—é—Ç `data="menu:<key>"`; –æ–±—â–∏–π —Ä–æ—É—Ç–µ—Ä –ª–æ–≤–∏—Ç `'^menu:'` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `dispatch_command`.
- –ö—ç—à –∫–Ω–æ–ø–æ–∫ –ø–æ —è–∑—ã–∫—É: `MENU_CACHE`.

## 2. –§–æ—Ä–º–∞—Ç –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é
–ü—Ä–∏–º–µ—Ä –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
```python
register_menu({
  'key': 'today',          # —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–ª—é—á
  'tr_key': 'menu_today',  # –∫–ª—é—á –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
  'plugin': 'today',       # –∏–º—è –ø–∞–ø–∫–∏ –ø–ª–∞–≥–∏–Ω–∞ (–∫–ª—é—á –≤ tlgbot._plugins)
  'handler': 'today_handler',  # –∏–º—è async —Ñ—É–Ω–∫—Ü–∏–∏
    'order': 10,             # –ø–æ—Ä—è–¥–æ–∫ (–º–µ–Ω—å—à–µ -> —Ä–∞–Ω—å—à–µ)
    # 'admin_only': True     # (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
})
```

## 3. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é
1. –°–æ–∑–¥–∞–π (–∏–ª–∏ –æ—Ç–∫—Ä–æ–π) —Ñ–∞–π–ª –ø–ª–∞–≥–∏–Ω–∞: `bot/plugins_bot/<newcmd>/<newcmd>.py`.
2. –í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤ –¥–æ–±–∞–≤—å:
```python
try:
    from bot.menu_system import register_menu
    register_menu({
        'key': 'newcmd',
        'tr_key': 'menu_newcmd',
        'plugin': 'newcmd',
        'handler': 'newcmd_handler',
        'order': 50
    })
except Exception:
    pass
```
3. –†–µ–∞–ª–∏–∑—É–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã:
```python
@tlgbot.on(tlgbot.cmd('newcmd'))
async def newcmd_handler(event):
    await event.respond("–ö–æ–º–∞–Ω–¥–∞ newcmd —Ä–∞–±–æ—Ç–∞–µ—Ç!")
```
4. –î–æ–±–∞–≤—å –ø–µ—Ä–µ–≤–æ–¥ –≤ –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –ª–æ–∫–∞–ª–∏ `bot/locales/*.json`:
```json
"menu_newcmd": "üÜï –ù–æ–≤–æ–µ"
```
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞. –ü—Ä–∏ `/start` –ø—É–Ω–∫—Ç –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## 4. –£–¥–∞–ª–∏—Ç—å –ø—É–Ω–∫—Ç –º–µ–Ω—é
1. –ù–∞–π–¥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é `register_menu({... 'key': 'X' ...})` –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º –ø–ª–∞–≥–∏–Ω–µ.
2. –£–¥–∞–ª–∏ –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —ç—Ç–æ—Ç –±–ª–æ–∫.
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞. (–ü—Ä–∏ hot-reload —Å—Ç–∞—Ä—ã–π –ø—É–Ω–∫—Ç –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –≤ –∫—ç—à–µ ‚Äî –æ—á–∏—Å—Ç–∫–∞: —Å–º. —Ä–∞–∑–¥–µ–ª 8.)

## 5. –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
1. –ü—Ä–∞–≤—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (`tr_key`) –≤ JSON —Ñ–∞–π–ª–∞—Ö –ª–æ–∫–∞–ª–µ–π.
2. –ù–µ –º–µ–Ω—è–π `key`, –∏–Ω–∞—á–µ —Å–ª–æ–º–∞–µ—Ç—Å—è callback —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
3. –û—á–∏—Å—Ç–∏ –∫—ç—à –º–µ–Ω—é (—Å–º. —Ä–∞–∑–¥–µ–ª 8) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ `/start` –∑–∞–Ω–æ–≤–æ ‚Äî –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞/—Ä–µ—Å—Ç–∞—Ä—Ç–µ –∫—ç—à –æ–±–Ω–æ–≤–∏—Ç—Å—è.

## 6. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å handler –∏–ª–∏ plugin
- –ï—Å–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª —Ñ–∞–π–ª –ø–ª–∞–≥–∏–Ω–∞ (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é) ‚Äî –æ–±–Ω–æ–≤–∏ –ø–æ–ª–µ `plugin` –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
- –ï—Å–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏—é ‚Äî –æ–±–Ω–æ–≤–∏ `handler`.
- –ò–Ω–∞—á–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –±—É–¥–µ—Ç –ª–æ–≥ `handler missing`.

## 7. –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫
- –ü—Ä–æ—Å—Ç–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π `order`. –ú–µ–Ω—å—à–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–¥—É—Ç –ø–µ—Ä–≤—ã–º–∏.
- –ö–Ω–æ–ø–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ 2 –≤ —Å—Ç—Ä–æ–∫–µ (–ª–æ–≥–∏–∫–∞ –≤ `build_menu`). –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏—Ç—å ‚Äî –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π `build_menu`.

## 8. –û—á–∏—Å—Ç–∫–∞ / –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –º–µ–Ω—é
–í –∫–æ–¥–µ:
```python
from bot.menu_system import invalidate_menu
invalidate_menu()        # –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à
invalidate_menu('ru')    # –æ—á–∏—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —è–∑—ã–∫–∞
```
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å —Å –∞–¥–º–∏–Ω—Å–∫–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏: –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (`<lang>|admin`). –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (`invalidate_menu()`) –Ω—É–∂–Ω–∞ –µ—Å–ª–∏ –º–µ–Ω—è–ª–∏—Å—å admin_only –ø—É–Ω–∫—Ç—ã.
–î–æ–±–∞–≤—å –≤—ã–∑–æ–≤ –ø–æ—Å–ª–µ –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è –ø—É–Ω–∫—Ç–æ–≤.

## 9. Debug / –ø—Ä–æ–≤–µ—Ä–∫–∏
- –õ–æ–≥–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: `menu_system: registered menu entry <key>`
- –õ–æ–≥ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏: `menu_system: callback router attached` (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
- –û—à–∏–±–∫–∞ –ø–ª–∞–≥–∏–Ω–∞: `plugin X not loaded` ‚Äî –ø–ª–∞–≥–∏–Ω –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è/–æ—à–∏–±–∫–∞ –≤ –Ω—ë–º.
- –û—à–∏–±–∫–∞ —Ö–µ–Ω–¥–ª–µ—Ä–∞: `handler Y missing` ‚Äî –æ–ø–µ—á–∞—Ç–∫–∞ –≤ –∏–º–µ–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏.

## 10. –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏
| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|---------|
| –ö–Ω–æ–ø–∫–∞ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç | –ù–µ—Ç callback —Ä–æ—É—Ç–µ—Ä–∞ | –£–±–µ–¥–∏—Å—å —á—Ç–æ –≤—ã–∑–≤–∞–Ω `init_menu_system` (–¥–µ–ª–∞–µ—Ç—Å—è –≤ `/start`) |
| –ü–æ—è–≤–∏–ª—Å—è —Å—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç | –ö—ç—à –Ω–µ –æ—á–∏—â–µ–Ω | `invalidate_menu()` –∏–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç |
| –ü–∞–¥–∞–µ—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ | –ù–µ–≤–µ—Ä–Ω—ã–π handler/plugin | –ò—Å–ø—Ä–∞–≤—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é |
| –ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á –≤ –ª–æ–∫–∞–ª–∏ | –î–æ–±–∞–≤—å –∫–ª—é—á –≤–æ –≤—Å–µ JSON |

## 11. –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
- [ ] –ö–æ–¥ –ø–ª–∞–≥–∏–Ω–∞ —Å–æ–∑–¥–∞–Ω
- [ ] register_menu –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] handler —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞
- [ ] –ü–æ—Ä—è–¥–æ–∫ (order) –≤—ã—Å—Ç–∞–≤–ª–µ–Ω
- [ ] (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) `admin_only: True`
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ `/start`

## 12. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É —Å—Ç—Ä–æ–∫–∏ (2) –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É.
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –ø—É–Ω–∫—Ç—ã (—Ñ–ª–∞–≥ `enabled` –≤ MenuEntry). *(—Å–ø–µ–∫—É–ª—è—Ü–∏—è)*
- –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª–µ–π (watcher). *(—Å–ø–µ–∫—É–ª—è—Ü–∏—è)*

## 13. FAQ
Q: –ù—É–∂–Ω–æ –ª–∏ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫–∏ –≤ start_cmd?  
A: –ù–µ—Ç, –æ–Ω–∏ —Å—Ç—Ä–æ—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞.

Q: –ú–æ–∂–Ω–æ –ª–∏ –∫–Ω–æ–ø–∫–µ –≤—ã–∑—ã–≤–∞—Ç—å –Ω–µ –∫–æ–º–∞–Ω–¥—É, –∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é?  
A: –î–∞, –≥–ª–∞–≤–Ω–æ–µ —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏—è –±—ã–ª–∞ async –∏ –∏–º—è —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å `handler`.

Q: –ß—Ç–æ –µ—Å–ª–∏ –¥–≤–∞ –ø–ª–∞–≥–∏–Ω–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π `key`?  
A: –í—Ç–æ—Ä–æ–π silently –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è ‚Äî —Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏.

Q: –ü–æ—á–µ–º—É –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–µ –≤–∏–¥–Ω—ã –æ–±—ã—á–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?  
A: –£ –ø—É–Ω–∫—Ç–∞ —Å—Ç–æ–∏—Ç `admin_only: True`, –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Telegram ID –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ –∞–¥–º–∏–Ω–æ–≤.

Q: –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω?  
A: –ß–µ—Ä–µ–∑ helper `_is_admin_user(user_id, admins)` ‚Äî –æ–Ω –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–∏–ø—ã (int/str) –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç.

---
–ö–æ—Ä–æ—Ç–∫–æ: –¥–æ–±–∞–≤–ª—è–µ—à—å register_menu + handler + –ø–µ—Ä–µ–≤–æ–¥ ‚Äî –≥–æ—Ç–æ–≤–æ.

## 14. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é
–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å pytest):
```python
from bot.menu_system import MENU_REGISTRY, register_menu, build_menu, invalidate_menu

def test_register_unique():
    invalidate_menu()
    before = len(MENU_REGISTRY)
    register_menu({'key':'_t1','tr_key':'menu_today','plugin':'today','handler':'today_handler','order':999})
    assert len(MENU_REGISTRY) == before + 1

def test_duplicate_ignored():
    before = len(MENU_REGISTRY)
    register_menu({'key':'_t1','tr_key':'menu_today','plugin':'today','handler':'today_handler','order':999})
    assert len(MENU_REGISTRY) == before  # –Ω–µ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å
```
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫: `buttons = build_menu('ru')` ‚Üí assert —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Å–ø–∏—Å–æ–∫ —Å–ø–∏—Å–∫–æ–≤), –Ω–∞–ª–∏—á–∏–µ callback data `menu:`.

## 15. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å *(–µ—Å–ª–∏ –≤–Ω–µ–¥—Ä—ë–Ω —Ñ–ª–∞–≥ enabled)*
- –†–∞—Å—à–∏—Ä—è–µ–º `MenuEntry` –ø–æ–ª–µ–º `enabled: bool = True`.
- –í `build_menu` –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –≥–¥–µ `enabled is False`.
- –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏:
```python
def disable_menu(key: str):
    for e in MENU_REGISTRY:
        if e.key == key:
            e.enabled = False
    MENU_CACHE.clear()

def enable_menu(key: str):
    for e in MENU_REGISTRY:
        if e.key == key:
            e.enabled = True
    MENU_CACHE.clear()
```
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç—å —ç–∫—Å–ø–æ—Ä—Ç ‚Üí `disable_menu('export')`.

## 16. –ê–¥–º–∏–Ω—Å–∫–∏–µ –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é
–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `admin_only` –≤ `MenuEntry`.

### 16.1 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```python
register_menu({
    'key': 'listusers',
    'tr_key': 'menu_listusers',
    'plugin': '_core',
    'handler': 'info_user_admin',
    'order': 900,
    'admin_only': True,
})
```

### 16.2 –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
–î–æ–±–∞–≤—å –∫–ª—é—á–∏ `menu_<key>` –≤–æ –≤—Å–µ JSON –ª–æ–∫–∞–ª–∏. –î–ª—è —Ç—Ä—ë—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∞–¥–º–∏–Ω—Å–∫–∏—Ö:
```
menu_listusers / menu_adduser / menu_deluser
```

### 16.3 –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏ –∫—ç—à
`build_menu(lang, is_admin)` —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫. –ö–ª—é—á –∫—ç—à–∞:
```
lang            # –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
f"{lang}|admin"  # –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
```
–≠—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç —É—Ç–µ—á–∫–∏: –∞–¥–º–∏–Ω –Ω–µ ¬´–∑–∞—à—É–º–ª—è–µ—Ç¬ª –º–µ–Ω—é –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.

### 16.4 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
–í `send_main_menu` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `_is_admin_user(user_id, admins)`:
```
def _is_admin_user(user_id, admins):
        # –ø—Ä–∏–≤–æ–¥–∏—Ç –≤—Å—ë –∫ int/str —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º–æ–º—É –≤–∏–¥—É, –ª–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–º–µ—à–∞–Ω–Ω—ã–µ —Ç–∏–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–∞ –≤ –ë–î –∏ int –≤ –∞–ø–¥–µ–π—Ç–µ).

### 16.5 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ü—Ä–∏–º–µ—Ä –∏–∑ `tests/test_admin_menu.py` (—É–ø—Ä–æ—â—ë–Ω–Ω–æ):
```python
buttons_admin = build_menu('ru', is_admin=True)
flat_admin = [b[0].data for row in buttons_admin for b in row]
assert any(d.endswith(':listusers') for d in flat_admin)

buttons_user = build_menu('ru', is_admin=False)
flat_user = [b[0].data for row in buttons_user for b in row]
assert not any(d.endswith(':listusers') for d in flat_user)
```

### 16.6 –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è
–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—Ç–∞—Ä—Ç–∞. –î–ª—è –≥–æ—Ä—è—á–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
```
from bot.menu_system import invalidate_menu
invalidate_menu()  # –æ—á–∏—Å—Ç–∏—Ç –æ–±–∞ —Å–ª–æ—è (–æ–±—ã—á–Ω—ã–π –∏ admin)
```

### 16.7 –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
| –°–∏–º–ø—Ç–æ–º | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|---------|---------|---------|
| –ê–¥–º–∏–Ω –Ω–µ –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É | –ï–≥–æ ID –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –∞–¥–º–∏–Ω–æ–≤ / –∫—ç—à –Ω–µ –æ—á–∏—â–µ–Ω | –î–æ–±–∞–≤—å ID, –≤—ã–∑–æ–≤–∏ `invalidate_menu()` |
| –û–±—ã—á–Ω—ã–π –≤–∏–¥–∏—Ç –∞–¥–º–∏–Ω—Å–∫—É—é | –°–º–µ—Å—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –∞–¥–º–∏–Ω–æ–º, –∫—ç—à –Ω–µ —Å–±—Ä–æ—à–µ–Ω | `invalidate_menu()` –∏ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª—å |
| –ö–Ω–æ–ø–∫–∞ –µ—Å—Ç—å, –Ω–æ –∫–ª–∏–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –ù–µ–≤–µ—Ä–Ω—ã–π handler –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è async —Ñ—É–Ω–∫—Ü–∏–∏ |

### 16.8 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ù–µ —Å—Ç–∞–≤–∏—Ç—å `order` –∞–¥–º–∏–Ω—Å–∫–∏—Ö –≤–ø–ª–æ—Ç–Ω—É—é –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º (–∏—Å–ø–æ–ª—å–∑—É–π –¥–∏–∞–ø–∞–∑–æ–Ω > 800).
- –õ–æ–∫–∞–ª–∏–∑—É–π –∫–æ—Ä–æ—Ç–∫–æ: –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ª–æ–º–∞—Ç—å —à–∏—Ä–∏–Ω—É —Å—Ç—Ä–æ–∫–∏.
- –õ–æ–≥–∏ —Å–º–æ—Ç—Ä–∏ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É `menu_system` –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ.

### 16.9 –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è *(–∏–¥–µ–∏)*
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–æ–≤ –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ (–∫–æ–º–∞–Ω–¥–∞ `/refresh_admins`).
- –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—É—â–µ–≥–æ –Ω–∞–±–æ—Ä–∞ –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é –∏ –∏—Ö —Ñ–ª–∞–≥–æ–≤.

---
–¢–∞–∫ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç—Å—è –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—É–Ω–∫—Ç—ã.

## 17. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö MenuEntry

–ö–ª–∞—Å—Å `MenuEntry` —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—É–Ω–∫—Ç–µ –º–µ–Ω—é:

```python
@dataclass
class MenuEntry:
    key: str  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    tr_key: str  # –ö–ª—é—á –ø–µ—Ä–µ–≤–æ–¥–∞
    plugin: str  # –ò–º—è –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
    handler: str  # –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
    order: int  # –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    admin_only: bool = False  # –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    # –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:
    # enabled: bool = True  # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å
    # custom_data: Dict[str, Any] = None  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

–ü—Ä–∏ –≤—ã–∑–æ–≤–µ `register_menu` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è –≤ —ç—Ç–æ—Ç –∫–ª–∞—Å—Å, –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ `key` –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ `MENU_REGISTRY`.

## 18. –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### 18.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—ç—à–∞
```python
MENU_CACHE: Dict[str, List[List[Button]]] = {}
```

–ö–ª—é—á–∏ –∫—ç—à–∞ –∏–º–µ—é—Ç –¥–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞:
- `ru`, `en`, `tt` –∏ —Ç.–¥. ‚Äî –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `ru|admin`, `en|admin` ‚Äî –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

–ó–Ω–∞—á–µ–Ω–∏—è ‚Äî –≥–æ—Ç–æ–≤—ã–µ —Å–ø–∏—Å–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.

### 18.2 –ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
1. –ü—Ä–∏ —è–≤–Ω–æ–º –≤—ã–∑–æ–≤–µ `invalidate_menu()`
2. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
3. –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (!)

### 18.3 –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞ –º–µ–Ω—é
–ú–µ–Ω—é —Å—Ç—Ä–æ–∏—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —è–∑—ã–∫–∞ (–ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è):

```python
def build_menu(lang, is_admin=False):
    cache_key = f"{lang}|admin" if is_admin else lang
    if cache_key in MENU_CACHE:
        return MENU_CACHE[cache_key]
    
    # –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é
    # ...
    
    MENU_CACHE[cache_key] = buttons
    return buttons
```

## 19. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ UI/UX –º–µ–Ω—é

### 19.1 –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∫–Ω–æ–ø–æ–∫
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏: `üóì –ö–∞–ª–µ–Ω–¥–∞—Ä—å`, `üìù –ó–∞–ø–∏—Å—å`, `‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏`
- –ì—Ä—É–ø–ø–∏—Ä—É–π –ø–æ—Ö–æ–∂–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ö–æ–∂–∏–º–∏ —ç–º–æ–¥–∑–∏ (üìäüìàüìâ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: 1-3 —Å–ª–æ–≤–∞ (–¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤)
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å—Ç–∏–ª—è: –≤—Å–µ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π/—Å—Ç—Ä–æ—á–Ω–æ–π, –≤—Å–µ —Å —ç–º–æ–¥–∑–∏/–±–µ–∑ —ç–º–æ–¥–∑–∏

### 19.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é
- –†–∞—Å–ø–æ–ª–∞–≥–∞–π —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –Ω–∞—á–∞–ª–µ (—Å –Ω–∏–∑–∫–∏–º `order`)
- –õ–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–∑–º–µ—â–∞–π —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ `order`
- –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–Ω–æ–ø–æ–∫ (>6) —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–º–µ–Ω—é –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã `order`:
  - 1-199: –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  - 200-599: –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  - 600-799: —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  - 800+: –∞–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 19.3 –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å
- –ü—Ä–æ–≤–µ—Ä—è–π –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é –≤ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞—Ö Telegram (iOS/Android/Desktop/Web)
- –£—á–∏—Ç—ã–≤–∞–π, —á—Ç–æ –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞—Ö –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç —Å–∂–∏–º–∞—Ç—å—Å—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è
- –¢–µ—Å—Ç–∏—Ä—É–π –≤–æ –≤—Å–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —è–∑—ã–∫–∞—Ö (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ —è–∑—ã–∫–∞—Ö —Å –¥–ª–∏–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏)

### 19.4 –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫
–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞ ‚Äî 2 –∫–Ω–æ–ø–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ, –Ω–æ –ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–æ–∂–Ω–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å:
- –í—ã–¥–µ–ª—è—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ—Å–æ–±—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ –¥–ª—è "–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
- –í–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏ (—ç–º–æ–¥–∑–∏, —Å—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–∞) –¥–ª—è –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –≥—Ä—É–ø–ø
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ—Ö–æ–∂–∏—Ö –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫

## 20. –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –º–µ–Ω—é

### 20.1 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ –∫–Ω–æ–ø–∫–∏
–°—á–µ—Ç—á–∏–∫–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–¥–∞—á –∏ —Ç.–¥.:

```python
async def build_menu_with_counters(user_id, lang):
    base_buttons = build_menu(lang, is_admin=_is_admin_user(user_id, ADMINS))
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏
    unread = await get_unread_count(user_id)
    tasks = await get_task_count(user_id)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –∫–Ω–æ–ø–æ–∫
    for row in base_buttons:
        for btn in row:
            if "menu:messages" in btn.data and unread > 0:
                btn.text = f"{btn.text} ({unread})"
            elif "menu:tasks" in btn.data and tasks > 0:
                btn.text = f"{btn.text} ({tasks})"
    
    return base_buttons
```

### 20.2 –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–µ–Ω—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞:

```python
async def build_contextual_menu(user_id, lang):
    # –ë–∞–∑–æ–≤–æ–µ –º–µ–Ω—é
    buttons = build_menu(lang, is_admin=_is_admin_user(user_id, ADMINS))
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–Ω–∫–µ—Ç—ã
    has_profile = await check_user_profile(user_id)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if not has_profile:
        profile_btn = Button.inline(
            i18n.t('menu_complete_profile', lang=lang),
            data="menu:complete_profile"
        )
        buttons.insert(0, [profile_btn])
    
    return buttons
```

### 20.3 –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω—é
–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ–Ω—é:

```python
async def get_user_menu_config(user_id):
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    settings = await get_user_settings(user_id)
    return settings.get('menu_config', {})

def filter_menu_by_user_config(buttons, user_config):
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏, –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    result = []
    for row in buttons:
        filtered_row = []
        for btn in row:
            key = btn.data.split(':', 1)[1]  # menu:key -> key
            if key in user_config.get('enabled_items', []):
                filtered_row.append(btn)
        if filtered_row:
            result.append(filtered_row)
    return result

## 21. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

### 21.1 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
–°–∏—Å—Ç–µ–º–∞ –º–µ–Ω—é –º–æ–∂–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:

```python
async def dispatch_command(event, key):
    user_id = event.sender_id
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Ñ–∞–π–ª
    logger.info(f"Menu action: user={user_id}, action={key}")
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –º–µ—Ç—Ä–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä Prometheus)
    menu_usage_counter.labels(menu_item=key).inc()
    
    # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞...
    plugin_name = None
    for entry in MENU_REGISTRY:
        if entry.key == key:
            plugin_name = entry.plugin
            handler_name = entry.handler
            # ...
```

### 21.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
–ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

```python
# –í —Å–∏—Å—Ç–µ–º–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
async def add_notification(user_id, notification_type):
    # –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await store_notification(user_id, notification_type)
    
    # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à –º–µ–Ω—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    invalidate_user_menu(user_id)

# –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ invalidation:
def invalidate_user_menu(user_id):
    # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    lang = get_user_language(user_id)
    is_admin = _is_admin_user(user_id, ADMINS)
    
    # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —è–∑—ã–∫–∞
    cache_key = f"{lang}|admin" if is_admin else lang
    if cache_key in MENU_CACHE:
        del MENU_CACHE[cache_key]
```

### 21.3 –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –º–µ–Ω—é –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø—Ä–∞–≤:

```python
@dataclass
class MenuEntry:
    key: str
    tr_key: str
    plugin: str
    handler: str
    order: int
    admin_only: bool = False
    required_permissions: List[str] = field(default_factory=list)  # –ù–æ–≤–æ–µ –ø–æ–ª–µ

def build_menu(lang, is_admin=False, user_permissions=None):
    # ...
    # –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É–Ω–∫—Ç—ã –ø–æ –ø—Ä–∞–≤–∞–º
    filtered_entries = []
    for entry in sorted_entries:
        if entry.admin_only and not is_admin:
            continue
        
        if entry.required_permissions:
            if not user_permissions:
                continue
            
            if not all(perm in user_permissions for perm in entry.required_permissions):
                continue
                
        filtered_entries.append(entry)
    # ...
```

## 22. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 22.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å –º–æ–∫–∞–º–∏

```python
@pytest.mark.asyncio
async def test_menu_dispatch():
    from bot.menu_system import dispatch_command
    
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã
    invalidate_menu()
    register_menu({
        'key': 'test_item',
        'tr_key': 'menu_test',
        'plugin': 'test_plugin',
        'handler': 'test_handler',
        'order': 999
    })
    
    # –°–æ–∑–¥–∞–µ–º –º–æ–∫-–æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è
    event = MagicMock()
    event.sender_id = 12345
    event.respond = AsyncMock()
    
    # –ú–æ–∫–∞–µ–º –∏–º–ø–æ—Ä—Ç –ø–ª–∞–≥–∏–Ω–∞ –∏ –≤—ã–∑–æ–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
    with patch('bot.menu_system.tlgbot._plugins', {
        'test_plugin': {
            'test_handler': AsyncMock()
        }
    }):
        # –í—ã–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–π –º–µ—Ç–æ–¥
        await dispatch_command(event, 'test_item')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—ã–ª –≤—ã–∑–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        tlgbot._plugins['test_plugin']['test_handler'].assert_called_once_with(event)
```

### 22.2 –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```python
def test_menu_admin_access():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –æ–±—ã—á–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∞–¥–º–∏–Ω—Å–∫—É—é –∫–Ω–æ–ø–∫—É
    register_menu({
        'key': 'admin_test',
        'tr_key': 'menu_admin_test',
        'plugin': 'admin',
        'handler': 'admin_handler',
        'order': 999,
        'admin_only': True
    })
    
    # –ü–æ–ª—É—á–∞–µ–º –º–µ–Ω—é –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_menu = build_menu('ru', is_admin=False)
    user_items = [btn.data for row in user_menu for btn in row]
    
    # –ü–æ–ª—É—á–∞–µ–º –º–µ–Ω—é –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    admin_menu = build_menu('ru', is_admin=True)
    admin_items = [btn.data for row in admin_menu for btn in row]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–¥–º–∏–Ω—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –≤ –º–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    assert 'menu:admin_test' not in user_items
    assert 'menu:admin_test' in admin_items
```
```
